<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>stamon-doc</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      border: none;
      border-top: 1px solid #1a1a1a;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
</head>
<body>
<h1 style="font-family: Arial; color: #00BBFF; text-align:center;">
<i>Stamon 文档站</i>
</h1>
<p><a href="../index.html">回到首页</a> <br> <a
href="index.html">回到上一级</a> <br></p>
<h1 id="工作日志">2025/10/05 工作日志</h1>
<p>本次更新的内部版本为2.4.53. 本次更新不会发布新版本。
本次更新以重构底层库为首要任务，对整个项目进行了大规模整改。</p>
<h3 id="重新布局移植接口">重新布局移植接口</h3>
<p>从今往后，“依赖库”这一称谓将会升级为“移植接口”。</p>
<p>我将<code>include/template</code>目录重命名为更方便理解的<code>include/interface</code>目录。
为了进行更有效且通用的接口约束，我参考了<code>CRTP</code>、<code>concept</code>和纯虚函数设计，自创了<code>CITP</code>这一设计。<code>CITP</code>初步原理的讲解位于<code>CITP设计文档.md</code>，CITP是个方便、易懂且几乎零成本抽象的设计，应该被广泛引用。</p>
<p>重构后的移植接口设计总述见<code>移植接口开发指导.md</code>。我们来看一看这一次重构对于接口的更改有哪些：</p>
<ul>
<li>将<code>BinaryReader.hpp</code>重命名为<code>FileReader.hpp</code></li>
<li>将<code>BinaryWriter.hpp</code>重命名为<code>FileWriter.hpp</code></li>
<li>将<code>stmlib.hpp</code>拆分为<code>StamonLib.hpp</code>、<code>BasicPlatform.hpp</code>、<code>BasicIo.hpp</code></li>
<li>用哈希表取代字典树，作为Map的底层数据结构与算法</li>
<li>删去<code>ByteMap.hpp</code>、<code>NumberMap.hpp</code>和<code>StringMap.hpp</code>，并用<code>HashMap.hpp</code>统一取而代之</li>
<li><code>HashMap</code>的值不一定是指针类型</li>
<li>只要给<code>HashMap</code>的键类型实现对应的<code>toHash</code>函数，HashMap就能正常运作</li>
<li>新增了各类基本数据类型和<code>String</code>的<code>toHash</code>函数</li>
<li><code>HashMap</code>的<code>getValList</code>函数原型改为<code>ArrayList&lt;ValType&gt; getValList() const</code></li>
<li><code>HashMap</code>新增<code>getKeyList</code>函数，原型为<code>ArrayList&lt;KeyType&gt; getKeyList() const</code></li>
<li>删去了<code>TypeDef.hpp</code></li>
<li>新增字节类型：<code>stamon::byte</code></li>
<li>新增容量整数类型：<code>stamon::size_t</code></li>
</ul>
<p>接下来，我可能会引入移植接口的<code>STL</code>实现。</p>
<h3 id="修改了大量细节">修改了大量细节</h3>
<ul>
<li>修改了<code>Ast.hpp</code>的命名空间声明</li>
<li>格式化了<code>CodeLogicAst.cpp</code>的代码</li>
<li>将<code>String((char*)"...")</code>修改成更简洁的<code>String("...")</code></li>
<li>删去了<code>Lexer.cpp</code>中不必要的内存申请和释放代码</li>
<li>将部分诸如<code>... == true</code>形式的代码改成<code>...</code></li>
<li>将部分诸如<code>... == false</code>形式的代码改成<code>!...</code></li>
<li>将Stamon的版本号定义从<code>stamon</code>迁移到<code>stamon::config</code></li>
<li>为<code>Parser.cpp</code>的所有宏代码末尾加上了分号</li>
<li>删去了<code>NumberType.cpp</code>中无用的<code>toThisType</code>函数</li>
<li>将<code>ObjectType.cpp</code>中的<code>virtual ArrayList&lt;Variable*&gt; getVal() const</code>改为<code>virtual const ArrayList&lt;Variable*&gt;&amp; getVal() const</code></li>
<li>在一些<code>namespace stamon</code>外部的函数实现内，加入了<code>using namespace stamon</code>，在不泄露命名空间的情况下，提升代码易读性，加快开发效率</li>
<li>重命名了智能指针的自定义销毁函数，提升代码易读性</li>
<li>修复了浮点数逻辑运算的结果是浮点数这一错误</li>
<li>调整了<code>Stamon.hpp</code>的实现</li>
<li>将<code>依赖库开发指导.md</code>重命名为<code>移植接口开发指导.md</code></li>
</ul>
<h3 id="优化程序性能">优化程序性能</h3>
<p>在重新选用Map的数据结构与算法，加之大量细节处修改之后，Stamon的性能得到了飞跃性提升。</p>
<p>为了更直观、客观的看到优化前后的差距，我选取了2.4.49发行版与2.4.53内部版本进行对比，两个版本都使用Makefile编译。测试在VirtualBox中的<code>Alpine Linux v3.22 x86_64</code>运行，我采用<code>perf 6.15.0</code>作为性能测试工具。</p>
<p>我们测试了三个样例：十万次空循环、朴素递归计算斐波那契数列第三十项、从2到50000的埃氏素数筛。</p>
<h5 id="十万次空循环的性能测试">十万次空循环的性能测试</h5>
<p>生成的原始结果分别如下：</p>
<pre><code># 优化前
# started on Sun Oct  5 18:25:30 2025


 Performance counter stats for &#39;stamon_old run demos/loop_old.stvc&#39;:

           5996.75 msec task-clock                       #    0.997 CPUs utilized             
               159      context-switches                 #   26.514 /sec                      
                 0      cpu-migrations                   #    0.000 /sec                      
              8965      page-faults                      #    1.495 K/sec                     
   &lt;not supported&gt;      cycles                                                                

       6.011989689 seconds time elapsed

       5.617046000 seconds user
       0.380536000 seconds sys</code></pre>
<pre><code># 优化后
# started on Sun Oct  5 18:23:02 2025


 Performance counter stats for &#39;stamon run demos/loop_new.stvc&#39;:

            232.40 msec task-clock                       #    0.974 CPUs utilized             
                 9      context-switches                 #   38.726 /sec                      
                 0      cpu-migrations                   #    0.000 /sec                      
              3639      page-faults                      #   15.658 K/sec                     
   &lt;not supported&gt;      cycles                                                                

       0.238499505 seconds time elapsed

       0.066635000 seconds user
       0.166589000 seconds sys</code></pre>
<h5
id="朴素递归计算斐波那契数列第三十项的性能测试">朴素递归计算斐波那契数列第三十项的性能测试</h5>
<p>生成的原始结果分别如下：</p>
<pre><code># 优化前
# started on Sun Oct  5 17:58:51 2025


 Performance counter stats for &#39;stamon_old run demos/fib_old.stvc&#39;:

         230904.82 msec task-clock                       #    1.000 CPUs utilized             
                10      context-switches                 #    0.043 /sec                      
                 0      cpu-migrations                   #    0.000 /sec                      
             39240      page-faults                      #  169.940 /sec                      
   &lt;not supported&gt;      cycles                                                                

     230.934695647 seconds time elapsed

      72.922803000 seconds user
     157.999407000 seconds sys</code></pre>
<pre><code># 优化后
# started on Sun Oct  5 18:15:50 2025


 Performance counter stats for &#39;stamon run demos/fib_new.stvc&#39;:

          11680.72 msec task-clock                       #    0.998 CPUs utilized             
                40      context-switches                 #    3.424 /sec                      
                 0      cpu-migrations                   #    0.000 /sec                      
             26722      page-faults                      #    2.288 K/sec                     
   &lt;not supported&gt;      cycles                                                                

      11.705414774 seconds time elapsed

       4.247985000 seconds user
       7.433974000 seconds sys</code></pre>
<h5
id="从2到50000的埃氏素数筛的性能测试">从2到50000的埃氏素数筛的性能测试</h5>
<p>生成的原始结果分别如下：</p>
<pre><code># 优化前
# started on Sun Oct  5 18:28:54 2025


 Performance counter stats for &#39;stamon_old run demos/nsieve_old.stvc&#39;:

          19057.96 msec task-clock                       #    0.998 CPUs utilized             
                26      context-switches                 #    1.364 /sec                      
                 1      cpu-migrations                   #    0.052 /sec                      
             19145      page-faults                      #    1.005 K/sec                     
   &lt;not supported&gt;      cycles                                                                

      19.087737930 seconds time elapsed

      12.488769000 seconds user
       6.573036000 seconds sys</code></pre>
<pre><code># 优化后
# started on Sun Oct  5 18:27:53 2025


 Performance counter stats for &#39;stamon run demos/nsieve_new.stvc&#39;:

            796.67 msec task-clock                       #    0.988 CPUs utilized             
                10      context-switches                 #   12.552 /sec                      
                 0      cpu-migrations                   #    0.000 /sec                      
              8652      page-faults                      #   10.860 K/sec                     
   &lt;not supported&gt;      cycles                                                                

       0.806208362 seconds time elapsed

       0.114124000 seconds user
       0.684745000 seconds sys</code></pre>
<h5 id="对优化前后的测试分析和结论">对优化前后的测试分析和结论</h5>
<p>上述原始测试结果被数据提取并整理成了以下表格：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">测试项</th>
<th style="text-align: left;">优化前耗时（按秒计）</th>
<th style="text-align: left;">优化后耗时（按秒计）</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">十万次空循环</td>
<td style="text-align: left;">6.011989689</td>
<td style="text-align: left;">0.238499505</td>
</tr>
<tr>
<td style="text-align: left;">朴素递归计算斐波那契数列第三十项</td>
<td style="text-align: left;">230.934695647</td>
<td style="text-align: left;">11.705414774</td>
</tr>
<tr>
<td style="text-align: left;">从2到50000的埃氏素数筛</td>
<td style="text-align: left;">19.087737930</td>
<td style="text-align: left;">0.806208362</td>
</tr>
</tbody>
</table>
<p>不难看出，得益于哈希表的优秀性能和细节处的代码优化，Stamon的性能得到了质的飞跃。</p>
<p><br></p>
<p><a href="20251005.gitlog.html">查看该文件的提交记录</a></p>
</body>
</html>
